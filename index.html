<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Fast Chat – 상담예약</title>
  <style>
    :root { --maxw: 820px; }
    *{ box-sizing:border-box; }
    body{ margin:0; background:#0b0f14; color:#e6edf3; font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,"Apple SD Gothic Neo",sans-serif; }
    .wrap{ max-width:var(--maxw); margin:0 auto; padding:24px 16px 120px; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    h1{ margin:0; font-size:18px; font-weight:700; }
    .lat{ font-size:12px; opacity:.7; }
    .chat{ display:flex; flex-direction:column; gap:10px; }
    .msg{ padding:12px 14px; border-radius:14px; white-space:pre-wrap; word-break:break-word; line-height:1.5; }
    .user{ align-self:flex-end; background:#1b2530; border:1px solid #253247; }
    .bot{ align-self:flex-start; background:#0f1720; border:1px solid #1a2635; }
    .sys{ align-self:center; font-size:12px; opacity:.7; }
    .pending{ opacity:.85; }
    .footer{ position:fixed; left:0; right:0; bottom:0; background:#0d141b; border-top:1px solid #1a2432; }
    .inp{ max-width:var(--maxw); margin:0 auto; display:grid; gap:8px; grid-template-columns:1fr auto auto auto; padding:12px 16px; }
    textarea{ height:44px; resize:none; padding:12px; border-radius:12px; border:1px solid #233045; background:#0b121a; color:#e6edf3; outline:none; }
    button{ height:44px; border-radius:12px; border:1px solid #2a3950; background:#15202b; color:#e6edf3; padding:0 14px; cursor:pointer; }
    button[disabled]{ opacity:.6; cursor:not-allowed; }
    .hint{ grid-column:1/-1; font-size:12px; opacity:.7; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 0; }
    .chip{ border:1px solid #334559; background:#14202b; padding:8px 12px; border-radius:999px; cursor:pointer; font-size:13px; }
    .chip:hover{ background:#192a3a; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>⚡ 상담 도우미</h1>
      <div class="lat" id="lat">TTFB: — / Done: —</div>
    </header>

    <div id="chat" class="chat" aria-live="polite"></div>

    <div class="row" id="firstMenu"></div>
    <div class="row" id="faqMenu" style="display:none"></div>
  </div>

  <div class="footer">
    <div class="inp">
      <textarea id="input" placeholder="메시지를 입력하세요 (Enter=전송, Shift+Enter=줄바꿈)" spellcheck="false"></textarea>
      <button id="send">전송</button>
      <button id="restart">다시시작</button>
      <button id="cancel" disabled>중단</button>
      <div class="hint"><strong>엔드포인트:</strong> <code id="ep"></code></div>
    </div>
  </div>

<script>
const API_URL = "https://stream-chat-worker.koreavisa.workers.dev/chat";
const START_URL = "https://stream-chat-worker.koreavisa.workers.dev/session/start";
document.getElementById('ep').textContent = API_URL;

const $chat = document.getElementById('chat');
const $lat  = document.getElementById('lat');
const $input= document.getElementById('input');
const $send = document.getElementById('send');
const $cancel=document.getElementById('cancel');
const $restart=document.getElementById('restart');
const $firstMenu=document.getElementById('firstMenu');
const $faqMenu=document.getElementById('faqMenu');

let controller=null;
let ASSIST = null; // null | 'progress' | 'indiRehab'
let SID = null;

init();

async function init(){
  SID = restoreSid();
  await startSession();
  greet();
  showFirstMenu();
}

function restoreSid(){
  try{
    let s = localStorage.getItem('sid');
    if (!s){ s = (crypto.randomUUID ? crypto.randomUUID() : Date.now()+"-"+Math.random().toString(16).slice(2)); localStorage.setItem('sid', s); }
    return s;
  }catch{ return String(Date.now()); }
}
async function startSession(){
  try{
    await fetch(START_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sid: SID, assistant: ASSIST||undefined }) });
  }catch(e){ console.warn(e); }
}

function greet(){
  addSys('아래 중 하나를 선택해 시작하세요.');
}
function showFirstMenu(){
  $firstMenu.style.display='flex';
  $firstMenu.innerHTML='';
  mkChip($firstMenu, '일반문의', ()=>{ ASSIST=null; showFaqMenu(); addBot('원하시는 항목을 선택해 주세요.'); });
  mkChip($firstMenu, '진행상황', ()=>{ ASSIST='progress'; hideFaqMenu(); addBot('진행상황 확인을 위해 몇 가지만 여쭤볼게요. 먼저 성함을 알려주세요.'); startSession(); });
  mkChip($firstMenu, '상담예약(개인회생)', ()=>{ ASSIST='indiRehab'; hideFaqMenu(); addBot('개인회생 상담을 도와드릴게요. 현재 상황을 편하게 말씀해 주시면 한 번에 하나씩 도와드리겠습니다.'); startSession(); });
}
function showFaqMenu(){
  $faqMenu.style.display='flex';
  $faqMenu.innerHTML='';
  // 이 버튼들은 /chat으로 그대로 보내어 FAQ_KV로 즉답 받음
  mkChip($faqMenu, '영업시간', ()=> sendText('영업시간 알려줘'));
  mkChip($faqMenu, '지점 주소', ()=> sendText('주소 알려줘'));
  mkChip($faqMenu, '팩스 번호', ()=> sendText('팩스 번호 알려줘'));
  mkChip($faqMenu, '이메일', ()=> sendText('이메일 주소 알려줘'));
}
function hideFaqMenu(){ $faqMenu.style.display='none'; }

function mkChip($row, label, onClick){
  const b = document.createElement('button');
  b.className='chip'; b.textContent=label; b.onclick=onClick; $row.appendChild(b);
}

function addMsg(role, text, pending=false){
  const div=document.createElement('div'); div.className=`msg ${role} ${pending?'pending':''}`; div.innerHTML=text; $chat.appendChild(div); $chat.scrollTop=$chat.scrollHeight; return div;
}
function addBot(t){ return addMsg('bot', t); }
function addUser(t){ return addMsg('user', t); }
function addSys(t){ const d=document.createElement('div'); d.className='sys'; d.textContent=t; $chat.appendChild(d); }

function setBusy(b){ $send.disabled=b; $cancel.disabled=!b; }
function fmtMs(ms){ return ms? `${ms}ms` : '—'; }

$send.onclick = ()=>{ const t=$input.value.trim(); if(!t) return; $input.value=''; sendText(t); };
$input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); $send.click(); }});
$cancel.onclick = ()=>{ if(controller) controller.abort(); };
$restart.onclick = async ()=>{
  try{ localStorage.removeItem('sid'); }catch{}
  SID = restoreSid(); ASSIST=null; $chat.innerHTML=''; hideFaqMenu(); showFirstMenu(); await startSession(); addSys('세션을 새로 시작했어요.');
};

async function sendText(text){
  addUser(text);
  setBusy(true);
  const t0=performance.now(); let tFirst=null; $lat.textContent='TTFB: … / Done: …';
  const bot=addMsg('bot','',true);
  try{
    controller = new AbortController();
    const resp = await fetch(API_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ message: text, sid: SID, assistant: ASSIST||undefined }),
      signal: controller.signal
    });
    if (!resp.ok || !resp.body) throw new Error(`서버 오류: ${resp.status}`);

    const reader = resp.body.getReader();
    const dec = new TextDecoder();
    let buffer='';
    while(true){
      const { value, done } = await reader.read();
      if (done) break;
      const chunk = dec.decode(value, { stream:true });
      if (tFirst===null){ tFirst=Math.round(performance.now()-t0); $lat.textContent=`TTFB: ${fmtMs(tFirst)} / Done: …`; }
      buffer += chunk;
      // SSE data 프레임만 붙임(서버가 JSON은 파싱해서 display만 보내므로 여기서는 그대로 출력)
      const frames = buffer.split('\n\n'); buffer = frames.pop();
      for (const f of frames){
        const line = f.split('\n').find(l=>l.startsWith('data:'));
        if (!line) continue;
        const data = line.replace(/^data:\s?/, '');
        if (!data || data==='[DONE]') continue;
        bot.innerHTML += data;
      }
    }
  }catch(e){
    bot.textContent += `\n[오류] ${e.message||e}`;
  }finally{
    bot.classList.remove('pending'); setBusy(false);
    const doneMs = Math.round(performance.now()-t0);
    $lat.textContent = `TTFB: ${fmtMs(tFirst)} / Done: ${fmtMs(doneMs)}`;
    controller=null;
  }
}
</script>
</body>
</html>

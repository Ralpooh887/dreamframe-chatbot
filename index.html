<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fast Chat – S1 프런트</title>
  <style>
    :root { --maxw: 820px; }
    * { box-sizing: border-box; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, "Apple SD Gothic Neo", sans-serif; margin: 0; background: #0b0f14; color: #e6edf3; }
    .wrap { max-width: var(--maxw); margin: 0 auto; padding: 24px 16px 160px; }
    header { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 12px; }
    .top { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    h1 { font-size: 18px; font-weight: 700; margin: 0; letter-spacing: .2px; }
    .latency { font-size: 12px; opacity: .75; }
    .controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .controls input, .controls select { height: 34px; padding: 0 10px; border-radius: 10px; border: 1px solid #233045; background: #0b121a; color: #e6edf3; }
    .controls button { height: 34px; border-radius: 10px; border: 1px solid #2a3950; background: #15202b; color: #e6edf3; padding: 0 10px; cursor: pointer; }
    .sid { font-size: 12px; opacity: .75; }
    .chat { display: flex; flex-direction: column; gap: 10px; }
    .msg { padding: 12px 14px; border-radius: 14px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
    .user { background: #1b2530; align-self: flex-end; border: 1px solid #253247; }
    .bot { background: #0f1720; align-self: flex-start; border: 1px solid #1a2635; }
    .pending { opacity: .85; }
    .sys { align-self: center; font-size: 12px; opacity: .7; }
    .footer { position: fixed; left: 0; right: 0; bottom: 0; background: #0d141b; border-top: 1px solid #1a2432; }
    .inp { max-width: var(--maxw); margin: 0 auto; display: grid; gap: 8px; grid-template-columns: 1fr auto auto; padding: 12px 16px; }
    textarea { resize: none; width: 100%; height: 44px; padding: 12px; border-radius: 12px; border: 1px solid #233045; background: #0b121a; color: #e6edf3; outline: none; }
    button { height: 44px; border-radius: 12px; border: 1px solid #2a3950; background: #15202b; color: #e6edf3; padding: 0 14px; cursor: pointer; }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    .hint { grid-column: 1 / -1; font-size: 12px; opacity: .7; }
    .link { color: #9bd2ff; text-decoration: none; }

    .missing { max-width: var(--maxw); margin: 0 auto; padding: 8px 16px 0; }
    .missing .box { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; padding: 10px; border: 1px dashed #2a3950; border-radius: 10px; background: #0b121a; }
    .missing label { font-size: 12px; opacity: .85; }
    .missing input { height: 34px; padding: 0 10px; border-radius: 10px; border: 1px solid #233045; background: #0b121a; color: #e6edf3; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="top">
        <h1>⚡ Fast Chat (S1)</h1>
        <div class="latency" id="latency">TTFB: — / Done: —</div>
      </div>

      <div class="controls">
        <label for="tenant">tenant</label>
        <input id="tenant" value="default" placeholder="tenant" />
        <label for="assistant">assistant</label>
        <select id="assistant">
          <option value="default" selected>default</option>
          <option value="sales">sales</option>
          <option value="support">support</option>
          <option value="visa">visa</option>
        </select>
        <button id="restartSmall">새 대화</button>
        <button id="finalize">상담 접수</button>
        <span class="sid" id="sidLbl"></span>
      </div>
    </header>

    <div id="chat" class="chat" aria-live="polite" aria-busy="false"></div>
  </div>

  <!-- 부족 정보 폼 -->
  <div id="missingBox" class="missing hidden">
    <div class="box" id="missingFields"></div>
  </div>

  <div class="footer">
    <div class="inp">
      <textarea id="input" placeholder="무엇이든 물어보세요… (Enter=전송, Shift+Enter=줄바꿈)" spellcheck="false"></textarea>
      <button id="send">전송</button>
      <button id="cancel" disabled>중단</button>
      <div class="hint">
        <strong>엔드포인트:</strong> <code id="endpointLbl"></code> · 
        <span>/session/start, /chat, /lead/finalize 사용</span>
      </div>
    </div>
  </div>

<script>
/***** 엔드포인트 설정 *****/
const WORKER_ORIGIN = "https://stream-chat-worker.koreavisa.workers.dev";
const API_URL = `${WORKER_ORIGIN}/chat`;          // 기존 코드 호환
const API_SESSION = `${WORKER_ORIGIN}/session/start`;
const API_FINALIZE = `${WORKER_ORIGIN}/lead/finalize`;
const USE_MOCK = false;

document.getElementById('endpointLbl').textContent = API_URL || (USE_MOCK ? '(MOCK 모드)' : '(미설정)');

const $chat = document.getElementById('chat');
const $input = document.getElementById('input');
const $send = document.getElementById('send');
const $cancel = document.getElementById('cancel');
const $latency = document.getElementById('latency');
const $tenant = document.getElementById('tenant');
const $assistant = document.getElementById('assistant');
const $sidLbl = document.getElementById('sidLbl');
const $missingBox = document.getElementById('missingBox');
const $missingFields = document.getElementById('missingFields');

let controller = null; // AbortController

const SID = (() => {
  try {
    let s = localStorage.getItem('sid');
    if (!s) {
      s = (crypto.randomUUID ? crypto.randomUUID() :
           (Date.now()+"-"+Math.random().toString(16).slice(2)));
      localStorage.setItem('sid', s);
    }
    return s;
  } catch {
    return String(Date.now());
  }
})();
updateSidLbl();

function updateSidLbl() {
  $sidLbl.textContent = `sid: ${SID.slice(0,8)}…`;
}

function addMsg(role, text, pending=false) {
  const div = document.createElement('div');
  div.className = `msg ${role} ${pending ? 'pending' : ''}`;
  div.textContent = text;
  $chat.appendChild(div);
  $chat.scrollTop = $chat.scrollHeight;
  return div;
}

function addSys(text) {
  const div = document.createElement('div');
  div.className = 'sys';
  div.textContent = text;
  $chat.appendChild(div);
  $chat.scrollTop = $chat.scrollHeight;
  return div;
}

function setBusy(b) {
  $send.disabled = b;
  $cancel.disabled = !b;
  $chat.setAttribute('aria-busy', String(b));
}

function fmtMs(ms) { return ms ? `${ms}ms` : '—'; }

async function startSession(sidOverride) {
  const sid = sidOverride || SID;
  try {
    await fetch(API_SESSION, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json; charset=utf-8' },
      body: JSON.stringify({ sid, tenant: $tenant.value || 'default', assistant: $assistant.value || 'default' }),
    });
  } catch (e) {
    console.warn('session/start fail', e);
  }
}

function getCtx() {
  return {
    sid: SID,
    tenant: $tenant.value || 'default',
    assistant: $assistant.value || 'default',
  };
}

// 공용 전송 함수(입력값 대신 직접 텍스트 보낼 때도 사용)
async function send(textOpt) {
  const text = (textOpt != null) ? String(textOpt).trim() : $input.value.trim();
  if (!text) return;
  if (!textOpt) $input.value = '';
  addMsg('user', text);

  setBusy(true);
  let t0 = performance.now();
  let tFirst = null;
  $latency.textContent = `TTFB: … / Done: …`;

  const bot = addMsg('bot', '', true);

  try {
    if (USE_MOCK || !API_URL) {
      await mockStream(bot, t0, (msFirst)=>{ tFirst = msFirst; $latency.textContent = `TTFB: ${fmtMs(tFirst)} / Done: …`; });
    } else {
      controller = new AbortController();
      const ctx = getCtx();
      const resp = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json; charset=utf-8' },
        body: JSON.stringify({ message: text, sid: ctx.sid, tenant: ctx.tenant, assistant: ctx.assistant }),
        signal: controller.signal,
      });

      if (!resp.ok || !resp.body) throw new Error(`서버 오류: ${resp.status}`);

      const reader = resp.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value, { stream: true });
        if (tFirst === null) {
          tFirst = Math.round(performance.now() - t0);
          $latency.textContent = `TTFB: ${fmtMs(tFirst)} / Done: …`;
        }
        buffer += chunk;

        const isSSE = (resp.headers.get('content-type') || '').includes('text/event-stream');
        if (isSSE) {
          const parts = buffer.split('\n\n');
          buffer = parts.pop();
          for (const p of parts) {
            const dataLines = p.split('\n')
              .filter(l => l.startsWith('data:'))
              .map(l => l.replace(/^data:\s?/, ''));
            for (const data of dataLines) {
              if (!data || data === '[DONE]') continue;
              let out = '';
              try {
                const obj = JSON.parse(data);
                if (obj?.choices?.length) {
                  for (const ch of obj.choices) out += (ch?.delta?.content || ch?.text || '');
                }
              } catch { out = data; }
              if (out) bot.textContent += out;
            }
          }
        } else {
          const lines = buffer.split('\n');
          buffer = lines.pop();
          for (const ln of lines) {
            const t = ln.trim();
            if (!t) continue;
            try {
              const obj = JSON.parse(t);
              const out = (obj?.delta ?? obj?.text ?? obj?.choices?.[0]?.delta?.content ?? '');
              bot.textContent += out || t;
            } catch { bot.textContent += t; }
          }
        }
      }
    }
  } catch (err) {
    console.error(err);
    bot.textContent += `\n[오류] ${err.message || err}`;
  } finally {
    bot.classList.remove('pending');
    setBusy(false);
    const doneMs = Math.round(performance.now() - t0);
    $latency.textContent = `TTFB: ${fmtMs(tFirst)} / Done: ${fmtMs(doneMs)}`;
    controller = null;
  }
}

// 부족 필드 폼 표시
function showMissingForm(missing) {
  $missingFields.innerHTML = '';
  for (const k of missing) {
    const label = document.createElement('label');
    label.textContent = k;
    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = `${k} 입력`;
    input.name = k;
    $missingFields.appendChild(label);
    $missingFields.appendChild(input);
  }
  const btn = document.createElement('button');
  btn.textContent = '빠르게 제출';
  btn.type = 'button';
  btn.style.marginLeft = '8px';
  btn.onclick = async () => {
    const values = {};
    [...$missingFields.querySelectorAll('input')].forEach(i => { values[i.name] = i.value.trim(); });
    // 대화로 한번에 전달 → 백엔드가 추출하여 KV에 저장
    const parts = [];
    if (values.name) parts.push(`제 이름은 ${values.name}입니다`);
    if (values.phone) parts.push(`연락처는 ${values.phone}입니다`);
    if (values.email) parts.push(`이메일은 ${values.email}입니다`);
    if (values.topic) parts.push(`상담 주제는 ${values.topic}입니다`);
    if (values.issue) parts.push(`이슈는 ${values.issue}입니다`);
    if (values.nationality) parts.push(`국적은 ${values.nationality}입니다`);
    if (values.visa_type) parts.push(`비자 유형은 ${values.visa_type}입니다`);
    const msg = parts.length ? parts.join('. ') + '.' : '정보를 입력했습니다.';
    await send(msg);
    // 잠시 후 자동 최종화 재시도
    setTimeout(finalizeLead, 900);
  };
  $missingFields.appendChild(btn);
  $missingBox.classList.remove('hidden');
}

async function finalizeLead() {
  try {
    const resp = await fetch(API_FINALIZE, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json; charset=utf-8' },
      body: JSON.stringify({ sid: SID }),
    });
    const j = await resp.json();
    if (j.ok) {
      $missingBox.classList.add('hidden');
      addSys('✅ 상담 접수 완료! 곧 연락드리겠습니다.');
    } else if (Array.isArray(j.missing) && j.missing.length) {
      addSys('ℹ️ 추가 정보가 필요합니다: ' + j.missing.join(', '));
      showMissingForm(j.missing);
    } else {
      addSys('접수 실패: ' + (j.error || '원인 불명'));
    }
  } catch (e) {
    addSys('접수 중 오류: ' + (e.message || e));
  }
}

async function mockStream(el, t0, onFirst) {
  const wait = (ms)=> new Promise(r=> setTimeout(r, ms));
  await wait(150 + Math.random()*250);
  onFirst(Math.round(performance.now() - t0));
  const demo = "안녕하세요! 여기는 백엔드 없이 동작하는 MOCK 모드입니다.\n\nS2에서 Cloudflare Workers의 /chat 엔드포인트가 준비되면, 상단의 엔드포인트 설정을 실제 주소로 바꾸고 USE_MOCK=false로 설정하세요.";
  const tokens = demo.split("");
  for (const ch of tokens) {
    el.textContent += ch;
    await wait(8 + Math.random()*10);
  }
}

/*** 이벤트 바인딩 ***/
$send.addEventListener('click', () => send());
$cancel.addEventListener('click', ()=> { if (controller) controller.abort(); });
$input.addEventListener('keydown', (e)=>{
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
});
document.getElementById('restartSmall').addEventListener('click', async () => {
  // 새 sid 발급
  const newSid = (crypto.randomUUID ? crypto.randomUUID() : (Date.now()+"-"+Math.random().toString(16).slice(2)));
  try { localStorage.setItem('sid', newSid); } catch {}
  location.reload(); // 간단히 리셋 (아래 onload에서 /session/start 호출)
});

document.getElementById('finalize').addEventListener('click', finalizeLead);

// tenant/assistant 변경 시 세션 업서트
$tenant.addEventListener('change', () => startSession(SID));
$assistant.addEventListener('change', () => startSession(SID));

/*** 초기 진입: 세션 보장 후 안내 ***/
(async () => {
  await startSession(SID);
  addSys('빠른 사용법: 메시지를 입력하고 Enter를 누르세요. 스트리밍으로 바로 표시됩니다.');
  addSys('TIP: 상단의 tenant/assistant를 바꿀 수 있고, "새 대화"를 누르면 새로운 세션으로 시작합니다.');
})();
</script>
</body>
</html>
